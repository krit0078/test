{% extends 'teacher/base.html' %}

{% block content %}

<!-- <section class="section-bg"> -->
<div class="container-fluid section-bg">
    <div class="row">
        <div class="col-md-3 bg-white border shadow-sm d-none d-md-block sticky-top"
            style="height: calc(100vh + 4rem);">
            {% include 'teacher/main_nav.html' %}
        </div>
        <div class="col-md-3 mb-3 bg-white border shadow-sm d-block d-md-none">
            {% include 'teacher/main_nav.html' %}
        </div>
        <div class="col-md-7 col-12 mb-3 mt-md-4">
            <div class="row justify-content-center">
                <div class="col-md-4 main-label text-center">
                    <h3><i class='bx bxs-user-check'></i> ปรึกษาผู้เชี่ยวชาญ</h3>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="rounded shadow-sm border p-3 bg-white cursor" data-toggle="modal"
                        data-target="#coach_t">
                        <img src="{{course.teacher.picture}}" class="img-fluid mb-3">
                        <h6 class="text-center">อีเมลล์ : {{course.teacher.email}}</h6>
                        <h5 class="text-center">ชื่อ : {{course.teacher.firstname}} {{course.teacher.lastname}}</h5>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="coach_t" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">ผู้เชี่ยวชาญ
                                    </h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body text-center">
                                    <img src="{{course.teacher.picture}}" class="img-fluid mb-3">
                                    <h6 class="text-center">อีเมลล์ : {{course.teacher.email}}</h6>
                                    <h5 class="text-center">ชื่อ : {{course.teacher.firstname}}
                                        {{course.teacher.lastname}}</h5>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% for i in co_teacher %}
                <div class="col-md-6 mb-3">
                    <div class="rounded shadow-sm border p-3 bg-white cursor" data-toggle="modal"
                        data-target="#coach_t_{{i.id}}">
                        <img src="{{i.member.picture}}" class="img-fluid mb-3">
                        <h6 class="text-center">อีเมลล์ : {{i.member.email}}</h6>
                        <h5 class="text-center">ชื่อ : {{i.member.firstname}} {{i.member.lastname}}</h5>
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="coach_t_{{i.id}}" tabindex="-1" role="dialog"
                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">ผู้เชี่ยวชาญ
                                    </h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body text-center">
                                    <img src="{{i.member.picture}}" class="img-fluid mb-3">
                                    <h6 class="text-center">อีเมลล์ : {{i.member.email}}</h6>
                                    <h5 class="text-center">ชื่อ : {{i.member.firstname}}
                                        {{i.member.lastname}}</h5>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% for i in coach %}
                <div class="col-md-6 mb-3">
                    <div class="rounded shadow-sm border p-3 bg-white cursor" data-toggle="modal"
                        data-target="#coach{{i.id}}">
                        {% for j in i.coach_file %}
                        <img src="{{j.file_link}}" class="img-fluid mb-3">
                        {% endfor %}
                        {% if i.email  %}
                        <h6 class="text-center">อีเมลล์ : {{i.email}}</h6>
                        {% endif %}
                        {% if i.name %}
                        <h5 class="text-center">ชื่อ : {{i.name}}</h5>
                        {% endif %}
                    </div>

                    <!-- Modal -->
                    <div class="modal fade" id="coach{{i.id}}" tabindex="-1" role="dialog"
                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">ผู้เชี่ยวชาญ
                                    </h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body text-center">
                                    {% for j in i.coach_file %}
                                    <img src="{{j.file_link}}" class="img-fluid mb-3">
                                    {% endfor %}
                                    {% if i.email  %}
                                    <h6 class="text-center">อีเมลล์ : {{i.email}}</h6>
                                    {% endif %}
                                    {% if i.name %}
                                    <h5 class="text-center">ชื่อ : {{i.name}}</h5>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>
        <div class="col-md-2 mb-3 mt-md-5">
            {% include 'teacher/main_right.html' %}
        </div>
    </div>
</div>
</div>
<!-- </section> -->
{% endblock %}

{% block modal %}


<!-- Modal -->
<div class="modal fade" id="CoachModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel"><i class="fas fa-camera"></i>
                    อัพโหลดภาพปก</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-cover" class="mb-2">
                    {% csrf_token %}
                    <div class="form-group row">
                        <label for="staticEmail" class="col-sm-3 col-form-label">ภาพปก</label>
                        <div class="col-sm-9">
                            <div class="custom-file mb-2">
                                <input type="file" class="custom-file-input" name="coach_pic" id="id_coach_pic"
                                    accept="image/*">
                                <label class="custom-file-label" for="validatedCustomFile">เลือกภาพผู้เชี่ยวชาญ</label>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="cropper-img" class="mb-2">
                    <img id="image" class="img-fluid" src="/uploads/0/cover/cover1.png">
                    <div class="text-right">
                        <button type="button" class="btn btn-primary mt-2" id="crop">ตกลง</button>
                    </div>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div class="alert" role="alert"></div>
                <script>
                    document.querySelector('.custom-file-input').addEventListener('change', function (e) {
                        var fileName = document.getElementById("id_coach_pic").files[0].name;
                        var nextSibling = e.target.nextElementSibling
                        nextSibling.innerText = fileName
                    });

                    //cropper image
                    window.addEventListener('DOMContentLoaded', function () {

                        var image = document.getElementById('image');
                        var input = document.getElementById('id_coach_pic');
                        var $progress = $('.progress');
                        var $progressBar = $('.progress-bar');
                        var $alert = $('.alert');
                        var $modal = $('#CoachModal');
                        var cropper;
                        var $add_cover = $('#add-cover');
                        var $cropper_img = $('#cropper-img');
                        $cropper_img.hide();
                        $progress.hide();


                        input.addEventListener('change', function (e) {
                            var files = e.target.files;
                            var done = function (url) {
                                input.value = '';
                                image.src = url;
                                $alert.hide();
                                $add_cover.hide();
                                $cropper_img.show();
                                create_crop();
                            };
                            var reader;
                            var file;
                            var url;

                            if (files && files.length > 0) {
                                file = files[0];

                                if (URL) {
                                    done(URL.createObjectURL(file));
                                } else if (FileReader) {
                                    reader = new FileReader();
                                    reader.onload = function (e) {
                                        done(reader.result);
                                    };
                                    reader.readAsDataURL(file);
                                }
                            }
                        });

                        function create_crop() {
                            let ratio = 1 / 1;
                            cropper = new Cropper(image, {
                                aspectRatio: ratio,
                                viewMode: 1,
                            });
                        }

                        $modal.on('hidden.bs.modal', function () {
                            cropper.destroy();
                            cropper = null;
                            $add_cover.show();
                            $cropper_img.hide();
                            image.src = "/uploads/0/img/user.png";
                        });

                        document.getElementById('crop').addEventListener('click', function () {
                            var canvas;

                            $progress.show();

                            if (cropper) {
                                canvas = cropper.getCroppedCanvas();


                                $progress.show();
                                // $alert.removeClass('alert-success alert-warning');
                                canvas.toBlob(function (blob) {
                                    var csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
                                    var form_data = new FormData();
                                    form_data.append('coach', blob, 'coach.jpg');
                                    form_data.append('csrfmiddlewaretoken', csrfToken);

                                    $.ajax('/classroom/{{course.id}}/task/{{task.0.id}}/coach/', {
                                        method: 'POST',
                                        data: form_data,
                                        processData: false,
                                        contentType: false,

                                        xhr: function () {
                                            var xhr = new XMLHttpRequest();

                                            xhr.upload.onprogress = function (e) {
                                                var percent = '0';
                                                var percentage = '0%';

                                                if (e.lengthComputable) {
                                                    percent = Math.round((e.loaded / e.total) * 100);
                                                    percentage = percent + '%';
                                                    $progressBar.width(percentage).attr('aria-valuenow', percent).text(percentage);
                                                }
                                            };

                                            return xhr;
                                        },

                                        success: function (data) {
                                            let txt = "";
                                            console.log(data);
                                            if (data.status == 0) {
                                                $alert.show().addClass('alert-success').text('You have no permission to update');
                                            }
                                            else {
                                                let show_file = $('#show_file');
                                                let d = data.data;
                                                $modal.modal('toggle')
                                                $modal.hide();
                                                $alert.show().addClass('alert-success').text('Upload success');
                                                txt += "<a href='" + d.file_link + "' style='text-decoration: none;color: #000;' target='_blank'><div class='row no-gutters rounded opengraph mb-2'><div class='col-3'><img src='" + d.file_link + "' style='width: 100%;'></div>";
                                                txt += "<div class='col-9 p-3 bg-light'><h5>" + d.file_name + "</h5></div></div></a>";
                                                txt += "<input type='hidden' name='file_id[]' value='" + d.id + "'>";
                                                show_file.append(txt);
                                            }
                                        },

                                        error: function (data) {
                                            console.log(data);
                                            $alert.show().addClass('alert-warning').text('Upload error');
                                        },

                                        complete: function () {
                                            $progress.hide();
                                        },
                                    });
                                });
                            }
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}